!function(a){"undefined"==typeof a.define&&(a.define=function(b,c){try{delete a.define}catch(d){a.define=void 0}"function"==typeof b?a.when=b():a[b]=c()},a.define.amd={});var b={VERSION:"0.1.0",defaults:{perPage:50}};a.Hook=b,b.Client=function(c){c||(c={}),this.url=c.endpoint||c.url||a.location.origin,this.app_id=c.app_id||c.appId||"",this.key=c.key||"",this.url.lastIndexOf("/")!=this.url.length-1&&(this.url+="/"),this.keys=new b.KeyValues(this),this.auth=new b.Auth(this),this.system=new b.System(this),b.Plugin.Manager.setup(this)},b.Client.prototype.collection=function(a){return new b.Collection(this,a)},b.Client.prototype.channel=function(a,c){"undefined"==typeof c&&(c={});var d=this.collection(a);return d.segments=d.segments.replace("collection/","channels/"),c.transport||(c.transport="sse"),c.transport=c.transport.toUpperCase(),new b.Channel[c.transport](this,d,c)},b.Client.prototype.post=function(a,b){return"undefined"==typeof b&&(b={}),this.request(a,"POST",b)},b.Client.prototype.get=function(a,b){return this.request(a,"GET",b)},b.Client.prototype.put=function(a,b){return this.request(a,"PUT",b)},b.Client.prototype.remove=function(a,b){return this.request(a,"DELETE",b)},b.Client.prototype.request=function(a,b,c){var d,e,f=when.defer(),g=!1;if(c&&c._sync&&(delete c._sync,g=!0),d=this.getPayload(b,c),e=this.getHeaders(),d instanceof FormData||(e["Content-Type"]="application/json"),"undefined"!=typeof XDomainRequest){a+="?X-App-Id="+this.app_id+"&X-App-Key="+this.key;var h=this.auth.getToken();h&&(a+="&X-Auth-Token="+h)}return f.promise.xhr=uxhr(this.url+a,d,{method:b,headers:e,sync:g,success:function(a){var b=null;try{b=JSON.parseWithDate(a)}catch(c){}b===!1||null===b||b.error?(b&&b.error&&console.error(b.error),f.resolver.reject(b)):f.resolver.resolve(b)},error:function(a){var b=null;try{b=JSON.parseWithDate(a)}catch(c){}console.log("Error: ",b||"Invalid JSON response."),f.resolver.reject(b)}}),f.promise},b.Client.prototype.getHeaders=function(){var a,b={"X-App-Id":this.app_id,"X-App-Key":this.key},a=this.auth.getToken();return a&&(b["X-Auth-Token"]=a),b},b.Client.prototype.getPayload=function(a,b){var c=null;if(b){if(b instanceof FormData)c=b;else if("GET"!==a){var d,e,f,g=new FormData,h=!1;for(d in b)e=b[d],f=null,"undefined"!=typeof e&&null!==e&&("boolean"==typeof e||"number"==typeof e||"string"==typeof e?e=e.toString():e instanceof HTMLInputElement&&e.files&&e.files.length>0?(f=e.files[0].name,e=e.files[0],h=!0):e instanceof HTMLInputElement?e=e.value:e instanceof HTMLCanvasElement?(e=dataURLtoBlob(e.toDataURL()),h=!0,f="canvas.png"):"undefined"!=typeof Blob&&e instanceof Blob&&(h=!0,f="blob."+e.type.match(/\/(.*)/)[1]),e instanceof Array||("string"==typeof e?g.append(d,e):g.append(d,e,f||"file")));h&&(c=g)}if(c=c||JSON.stringify(b,function(a,b){return this[a]instanceof Date?Math.round(this[a].getTime()/1e3):b}),"{}"==c)return null;"GET"===a&&"string"==typeof c&&(c=encodeURIComponent(c))}return c},b.Client.prototype.serialize=function(a,b){var c=[];for(var d in a)if(a.hasOwnProperty(d)){var e=b?b+"["+d+"]":d,f=a[d];c.push("object"==typeof f?this.serialize(f,e):encodeURIComponent(e)+"="+encodeURIComponent(f))}return c.join("&")},b.Events=function(){this._events={}},b.Events.prototype.on=function(a,b,c){this._events[a]||(this._events[a]=[]),this._events[a].push({callback:b,context:c||this})},b.Events.prototype.trigger=function(a){var b,c=Array.prototype.slice.call(arguments,1);if(this._events[a])for(var d=0,e=this._events[a].length;e>d;d++)b=this._events[a][d],b.callback.apply(b.context||this.client,c)},b.Iterable=function(){},b.Iterable.prototype={each:function(a){return this._iterate("each",a)},find:function(a){return this._iterate("find",a)},filter:function(a){return this._iterate("filter",a)},max:function(a){return this._iterate("max",a)},min:function(a){return this._iterate("min",a)},every:function(a){return this._iterate("every",a)},reject:function(a,b){return this._iterate("reject",a,b)},groupBy:function(a,b){return this._iterate("groupBy",a,b)},_iterate:function(a,b,c){var d=when.defer();return this.then(function(e){var f=_[a].call(_,e,b,c);d.resolver.resolve(f)}).otherwise(function(a){d.resolver.reject(a)}),d.promise}},"undefined"==typeof a.FormData&&(a.FormData=function(){this.append=function(){}}),a.location.origin||(a.location.origin=a.location.protocol+"//"+a.location.hostname+(a.location.port?":"+a.location.port:"")),b.Plugin={},b.Plugin.Manager={plugins:[]},b.Plugin.Manager.register=function(a,b){this.plugins.push({path:a,klass:b})},b.Plugin.Manager.setup=function(a){for(var b=0,c=this.plugins.length;c>b;b++)a[this.plugins[b].path]=new this.plugins[b].klass(a)},b.Auth=function(c){this.client=c,this.currentUser=null;var d=new Date,e=new Date(a.localStorage.getItem(this.client.appId+"-"+b.Auth.AUTH_TOKEN_EXPIRATION)),f=a.localStorage.getItem(this.client.appId+"-"+b.Auth.AUTH_DATA_KEY);f&&d.getTime()<e.getTime()&&(this.currentUser=JSON.parse(f))},b.Auth.prototype=new b.Events,b.Auth.prototype.constructor=b.Auth,b.Auth.AUTH_DATA_KEY="dl-api-auth-data",b.Auth.AUTH_TOKEN_KEY="dl-api-auth-token",b.Auth.AUTH_TOKEN_EXPIRATION="dl-api-auth-token-expiration",b.Auth.prototype.setCurrentUser=function(c){return c?(a.localStorage.setItem(this.client.appId+"-"+b.Auth.AUTH_DATA_KEY,JSON.stringify(c)),this.currentUser=c,this.trigger("login",c)):(this.trigger("logout",this.currentUser),this.currentUser=c,a.localStorage.removeItem(this.client.appId+"-"+b.Auth.AUTH_TOKEN_KEY),a.localStorage.removeItem(this.client.appId+"-"+b.Auth.AUTH_DATA_KEY)),this},b.Auth.prototype.register=function(a,b){var c,d=this;return"undefined"==typeof b&&(b={}),c=this.client.post("auth/"+a,b),c.then(function(a){d._registerToken(a)}),c},b.Auth.prototype.login=function(a,b){var c,d=this;return"undefined"==typeof b&&(b={}),c=this.client.post("auth/"+a+"/login",b),c.then(function(a){d._registerToken(a)}),c},b.Auth.prototype.update=function(a){if(!this.currentUser)throw new Error("not logged in.");var b=this,c=this.client.collection("auth").update(this.currentUser._id,a);return c.then(function(a){b.setCurrentUser(a)}),c},b.Auth.prototype.forgotPassword=function(a){return"undefined"==typeof a&&(a={}),this.client.post("auth/email/forgotPassword",a)},b.Auth.prototype.resetPassword=function(b){if("string"==typeof b&&(b={password:b}),"undefined"==typeof b.token&&(b.token=a.location.href.match(/[\?|&]token=([a-z0-9]+)/),b.token=b.token&&b.token[1]),"string"!=typeof b.token)throw new Error("forgot password token required. Remember to use 'auth.forgotPassword' before 'auth.resetPassword'.");if("string"!=typeof b.password)throw new Error("new password required.");return this.client.post("auth/email/resetPassword",b)},b.Auth.prototype.logout=function(){return this.setCurrentUser(null)},b.Auth.prototype.getToken=function(){return a.localStorage.getItem(this.client.appId+"-"+b.Auth.AUTH_TOKEN_KEY)},b.Auth.prototype._registerToken=function(c){c.token&&(a.localStorage.setItem(this.client.appId+"-"+b.Auth.AUTH_TOKEN_KEY,c.token.token),a.localStorage.setItem(this.client.appId+"-"+b.Auth.AUTH_TOKEN_EXPIRATION,c.token.expire_at),delete c.token,this.setCurrentUser(c))},b.Channel={},b.Collection=function(a,b){this.client=a,this.name=this._validateName(b),this.reset(),this.segments="collection/"+this.name},b.Collection.prototype=new b.Iterable,b.Collection.prototype.constructor=b.Collection,b.Collection.prototype.create=function(a){return this.client.post(this.segments,a)},b.Collection.prototype.select=function(){return this.options.select=arguments,this},b.Collection.prototype.get=function(){return this.client.get(this.segments,this.buildQuery())},b.Collection.prototype.where=function(a,b,c,d){var e,f="undefined"==typeof c?"=":b,g="undefined"==typeof c?b:c,h="undefined"==typeof d?"and":d;if("object"==typeof a)for(e in a)a.hasOwnProperty(e)&&(f="=",a[e]instanceof Array?(f=a[e][0],g=a[e][1]):g=a[e],this.addWhere(e,f,g,h));else this.addWhere(a,f,g,h);return this},b.Collection.prototype.orWhere=function(a,b,c){return this.where(a,b,c,"or")},b.Collection.prototype.find=function(a){var b=this.client.get(this.segments+"/"+a,this.buildQuery());return arguments.length>1?b.then.apply(b,Array.prototype.slice.call(arguments,1)):b},b.Collection.prototype.with=function(){return this.options.with=arguments,this},b.Collection.prototype.distinct=function(){return this.options.distinct=!0,this},b.Collection.prototype.group=function(){return this._group=arguments,this},b.Collection.prototype.count=function(a){a="undefined"==typeof a?"*":a,this.options.aggregation={method:"count",field:a};var b=this.get();return arguments.length>0&&b.then.apply(b,arguments),b},b.Collection.prototype.max=function(a){this.options.aggregation={method:"max",field:a};var b=this.get();return arguments.length>1&&b.then.apply(b,Array.prototype.slice.call(arguments,1)),b},b.Collection.prototype.min=function(a){this.options.aggregation={method:"min",field:a};var b=this.get();return arguments.length>1&&b.then.apply(b,Array.prototype.slice.call(arguments,1)),b},b.Collection.prototype.avg=function(a){this.options.aggregation={method:"avg",field:a};var b=this.get();return arguments.length>1&&b.then.apply(b,Array.prototype.slice.call(arguments,1)),b},b.Collection.prototype.sum=function(a){this.options.aggregation={method:"sum",field:a};var b=this.get();return arguments.length>1&&b.then.apply(b,Array.prototype.slice.call(arguments,1)),b},b.Collection.prototype.first=function(){this.options.first=1;var a=this.get();return a.then.apply(a,arguments),a},b.Collection.prototype.firstOrCreate=function(a){return this.options.first=1,this.options.data=a,this.client.post(this.segments,this.buildQuery())},b.Collection.prototype.then=function(){var a=this.get();return a.then.apply(a,arguments),a},b.Collection.prototype.debug=function(a){return a="undefined"==typeof a?"log":a,this.then(console[a].bind(console))},b.Collection.prototype.reset=function(){return this.options={},this.wheres=[],this.ordering=[],this._group=[],this._limit=null,this._offset=null,this._remember=null,this},b.Collection.prototype.sort=function(a,b){return b?"number"==typeof b&&(b=-1===parseInt(b,10)?"desc":"asc"):b="asc",this.ordering.push([a,b]),this},b.Collection.prototype.limit=function(a){return this._limit=a,this},b.Collection.prototype.offset=function(a){return this._offset=a,this},b.Collection.prototype.remember=function(a){return this._remember=a,this},b.Collection.prototype.channel=function(){throw new Error("Not implemented.")},b.Collection.prototype.paginate=function(a,c,d){var e=new b.Pagination(this);return c||(c=a,a=b.defaults.perPage),this.options.paginate=a,this.then(function(a){e._fetchComplete(a),c&&c(e)},d),e},b.Collection.prototype.drop=function(){return this.client.remove(this.segments)},b.Collection.prototype.remove=function(a){var b=this.segments;return"undefined"!=typeof a&&(b+="/"+a),this.client.remove(b,this.buildQuery())},b.Collection.prototype.update=function(a,b){return this.client.post(this.segments+"/"+a,b)},b.Collection.prototype.increment=function(a,b){this.options.operation={method:"increment",field:a,value:b};var c=this.client.put(this.segments,this.buildQuery());return arguments.length>0&&c.then.apply(c,arguments),c},b.Collection.prototype.decrement=function(a,b){this.options.operation={method:"decrement",field:a,value:b};var c=this.client.put(this.segments,this.buildQuery());return arguments.length>0&&c.then.apply(c,arguments),c},b.Collection.prototype.updateAll=function(a){return this.options.data=a,this.client.put(this.segments,this.buildQuery())},b.Collection.prototype.addWhere=function(a,b,c,d){return this.wheres.push([a,b.toLowerCase(),c,d]),this},b.Collection.prototype._validateName=function(a){var b=/^[a-z_\/0-9]+$/;if(!b.test(a))throw new Error("Invalid name: "+a);return a},b.Collection.prototype.buildQuery=function(){var a={};null!==this._limit&&(a.limit=this._limit),null!==this._offset&&(a.offset=this._offset),null!==this._remember&&(a.remember=this._remember),this.wheres.length>0&&(a.q=this.wheres),this.ordering.length>0&&(a.s=this.ordering),this._group.length>0&&(a.g=this._group);var b,c={paginate:"p",first:"f",aggregation:"aggr",operation:"op",data:"data","with":"with",select:"select",distinct:"distinct"};for(b in c)this.options[b]&&(a[c[b]]=this.options[b]);return this.reset(),a},b.CollectionItem=function(){},b.KeyValues=function(a){this.client=a},b.KeyValues.prototype.get=function(a,b){var c=this.client.get("key/"+a);return b&&c.then.apply(c,[b]),c},b.KeyValues.prototype.set=function(a,b){return this.client.post("key/"+a,{value:b})},b.Model=function(){},b.Pagination=function(a){this.fetching=!0,this.collection=a},b.Pagination.prototype._fetchComplete=function(a){this.fetching=!1,this.total=a.total,this.per_page=a.per_page,this.current_page=a.current_page,this.last_page=a.last_page,this.from=a.from,this.to=a.to,this.items=a.data},b.Pagination.prototype.hasNext=function(){return this.current_page<this.to},b.Pagination.prototype.isFetching=function(){return this.fetching},b.Pagination.prototype.then=function(){},b.System=function(a){this.client=a},b.System.prototype.time=function(){var a=this.client.get("system/time");return arguments.length>0&&a.then.apply(a,arguments),a},b.Channel.SSE=function(a,b,c){this.collection=b,this.client_id=null,this.callbacks={},this.options=c||{},this.readyState=null},b.Channel.SSE.prototype.subscribe=function(a,b){"undefined"==typeof b&&(b=a,a="_default"),this.callbacks[a]=b;var c=this.connect();if(this.readyState===EventSource.CONNECTING){var d=this;c.then(function(){d.event_source.onopen=function(a){d.readyState=a.readyState,d._trigger.apply(d,["state:"+a.type,a])},d.event_source.onerror=function(a){d.readyState=a.readyState,d._trigger.apply(d,["state:"+a.type,a])},d.event_source.onmessage=function(a){var b=JSON.parse(a.data),c=b.event;delete b.event,d._trigger.apply(d,[c,b])}})}return c},b.Channel.SSE.prototype._trigger=function(a,b){console.log("Trigger: ",a,b),-1===a.indexOf("state:")&&this.callbacks._default&&this.callbacks._default.apply(this,[a,b]),this.callbacks[a]&&this.callbacks[a].apply(this,[b])},b.Channel.SSE.prototype.isConnected=function(){return null!==this.readyState&&this.readyState!==EventSource.CLOSED},b.Channel.SSE.prototype.unsubscribe=function(a){this.callbacks[a]&&(this.callbacks[a]=null)},b.Channel.SSE.prototype.publish=function(a,b){return"undefined"==typeof b&&(b={}),b.client_id=this.client_id,b.event=a,this.collection.create(b)},b.Channel.SSE.prototype.connect=function(){if(null!==this.readyState){var b=when.defer();return b.resolver.resolve(),b.promise}this.readyState=EventSource.CONNECTING,this._trigger.apply(this,["state:connecting"]);var c=this;return this.publish("connected").then(function(b){c.collection.where("updated_at",">",b.updated_at);var d="X-App-Id="+c.collection.client.appId+"&X-App-Key="+c.collection.client.key,e=c.collection.client.auth.getToken();e&&(d+="&X-Auth-Token="+e);var f=c.collection.buildQuery();f.stream={refresh:c.options.refresh_timeout||1,retry:c.options.retry_timeout||1},c.client_id=b.client_id,c.event_source=new EventSource(c.collection.client.url+c.collection.segments+"?"+d+"&"+JSON.stringify(f),{withCredentials:!0}),a.addEventListener("unload",function(){c.disconnect(!0)})},function(a){c.readyState=EventSource.CLOSED,c._trigger.apply(c,["state:error",a])})},b.Channel.SSE.prototype.disconnect=function(a){return this.isConnected()&&(this.close(),this.publish("disconnected",{_sync:"undefined"!=typeof a&&a})),this},b.Channel.SSE.prototype.close=function(){return this.event_source&&this.event_source.close(),this.readyState=EventSource.CLOSED,this},b.Channel.WEBSOCKETS=function(b,c,d){var e=this;if(this.client=b,this.collection=c,this.client_id=null,!d.url){var f="https:"===a.location.protocol?"wss://":"ws://",g=b.url.replace(/(?:https?:)?\/\//,f);g.match(/index\.php/)?g=g.replace("index.php","ws/"):g+="ws/",d.url=g}d.url+=this.collection.name+"?X-App-Id="+this.client.appId+"&X-App-Key="+this.client.key;var h=this.client.auth.getToken();h&&(d.url+="&X-Auth-Token="+h),ab.debug(d.debug===!0,d.verbose===!0,d.debug===!0),this.queued_subscriptions={},this.on("connected",function(){for(var a in e.queued_subscriptions)e.queued_subscriptions.hasOwnProperty(a)&&e.subscribe(a,e.queued_subscriptions[a]);e.queued_subscriptions=null}),ab.connect(d.url,function(a){e.ws=a,e.client_id=a.sessionid(),e.trigger("connected")},function(a){console.error("Can't connect with WebSocket server: "+d.url,a)},{retryDelay:1e3,maxRetries:10})},b.Channel.WEBSOCKETS.prototype=new b.Events,b.Channel.WEBSOCKETS.prototype.constructor=b.Channel.WEBSOCKETS,b.Channel.WEBSOCKETS.prototype.subscribe=function(a,b){return this.ws?this.ws.subscribe(this.collection.name+"."+a,function(a,c){b(c)}):this.queued_subscriptions[a]=b,this},b.Channel.WEBSOCKETS.prototype.isConnected=function(){return this.ws&&this.ws._websocket_connected},b.Channel.WEBSOCKETS.prototype.unsubscribe=function(a){return this.ws&&this.ws._subscriptions[this.collection.name+"."+a]&&this.ws.unsubscribe(this.collection.name+"."+a),this},b.Channel.WEBSOCKETS.prototype.publish=function(a,b,c){var d=[],e=[];return"undefined"==typeof c&&(c={}),c.exclude&&c.exclude instanceof Array&&(d=c.exclude),c.eligible&&c.eligible instanceof Array&&(e=c.eligible),this.ws.publish(this.collection.name+"."+a,b,d,e),this},b.Channel.WEBSOCKETS.prototype.disconnect=function(){return this.ws.close(),this},b.Channel.WEBSOCKETS.prototype.call=function(a,b){return this.ws.call(a,b),this},b.Channel.WEBSOCKETS.prototype.connect=function(){return this.ws.connect(),this}}(this);